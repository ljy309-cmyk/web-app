#!/bin/sh

echo "=== Pre-commit 검증 시작 ==="

# 1. Prettier 포맷 체크 (루트 설정 파일)
echo "[1/3] Prettier 포맷 체크..."
npx prettier --check "*.{json,yml,yaml,md}" ".ai-context.yml" "frontend/src/**/*.{ts,tsx,css}" "frontend/*.{ts,json}" 2>/dev/null
if [ $? -ne 0 ]; then
  echo "❌ 포맷이 맞지 않는 파일이 있습니다. 커밋이 중단됩니다."
  echo "   수정: npx prettier --write ."
  exit 1
fi

# 2. Frontend 검증 (변경된 파일이 있을 때만)
FRONTEND_CHANGED=$(git diff --cached --name-only | grep "^frontend/" || true)
if [ -n "$FRONTEND_CHANGED" ]; then
  echo "[2/3] Frontend 검증..."
  if [ -d "frontend/node_modules" ]; then
    cd frontend
    npx tsc --noEmit
    if [ $? -ne 0 ]; then
      echo "❌ Frontend TypeScript 타입 에러가 있습니다."
      exit 1
    fi
    cd ..
  else
    echo "  ⚠️ frontend/node_modules 없음, 건너뜀"
  fi
else
  echo "[2/3] Frontend 변경 없음, 건너뜀"
fi

# 3. Backend 검증 (변경된 파일이 있을 때만)
BACKEND_CHANGED=$(git diff --cached --name-only | grep "^backend/" || true)
if [ -n "$BACKEND_CHANGED" ]; then
  echo "[3/3] Backend 검증..."
  if command -v ruff &>/dev/null; then
    ruff check backend/
    if [ $? -ne 0 ]; then
      echo "❌ Backend 린트 에러가 있습니다."
      exit 1
    fi
  else
    echo "  ⚠️ ruff 미설치, 건너뜀"
  fi
else
  echo "[3/3] Backend 변경 없음, 건너뜀"
fi

echo "=== ✅ 모든 검증 통과! 커밋을 진행합니다. ==="

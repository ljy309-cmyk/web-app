#!/bin/sh

echo "=== Pre-commit 검증 시작 ==="

# 1. Prettier 포맷 체크
echo "[1/5] Prettier 포맷 체크..."
npx prettier --check .
if [ $? -ne 0 ]; then
  echo "❌ 포맷이 맞지 않는 파일이 있습니다. 커밋이 중단됩니다."
  echo "   수정: npm run format"
  exit 1
fi

# 2. 보안 취약점 검사 (high/critical, 프로덕션 의존성만)
echo "[2/5] npm audit (보안 취약점 검사)..."
npm audit --audit-level=high --omit=dev 2>/dev/null
if [ $? -ne 0 ]; then
  echo "❌ high/critical 보안 취약점이 있습니다. 커밋이 중단됩니다."
  echo "   수정: npm audit fix"
  exit 1
fi

# 3. TypeScript 타입 체크 (모든 워닝 = 에러)
echo "[3/5] TypeScript 타입 체크..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "❌ TypeScript 타입 에러가 있습니다. 커밋이 중단됩니다."
  exit 1
fi

# 4. ESLint 검사 (워닝 0개 허용 + 접근성 a11y 규칙 포함)
echo "[4/5] ESLint 검사 (a11y 포함)..."
npx eslint --max-warnings 0 .
if [ $? -ne 0 ]; then
  echo "❌ ESLint 에러/워닝이 있습니다. 커밋이 중단됩니다."
  exit 1
fi

# 5. 단위 테스트 + 스냅샷 테스트 + 커버리지 100% 검증
echo "[5/5] 단위/스냅샷 테스트 (커버리지 100% 필수)..."
npx vitest run --coverage
if [ $? -ne 0 ]; then
  echo "❌ 테스트 실패 또는 커버리지 100% 미달입니다. 커밋이 중단됩니다."
  echo "   스냅샷 갱신이 필요하면: npx vitest run --update"
  exit 1
fi

echo "=== ✅ 모든 검증 통과! 커밋을 진행합니다. ==="

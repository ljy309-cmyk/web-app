name: Dependency Update Check

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ 09:00 KST (ì¼ìš”ì¼ 24:00 UTC)
    - cron: "0 0 * * 1"
  workflow_dispatch:

permissions:
  issues: write

jobs:
  check:
    name: Check Outdated Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
      - run: npm ci

      - name: ë©”ì´ì € ì—…ë°ì´íŠ¸ í™•ì¸
        id: outdated
        run: |
          # npm outdatedëŠ” ì—…ë°ì´íŠ¸ê°€ ìˆìœ¼ë©´ exit 1ì„ ë°˜í™˜í•˜ë¯€ë¡œ ë¬´ì‹œ
          npm outdated --json > /tmp/outdated.json || true

          # ë©”ì´ì € ì—…ë°ì´íŠ¸ë§Œ í•„í„°ë§ (currentì™€ latestì˜ ë©”ì´ì € ë²„ì „ì´ ë‹¤ë¥¸ ê²ƒ)
          node -e '
            const data = require("/tmp/outdated.json");
            const majors = [];
            for (const [pkg, info] of Object.entries(data)) {
              if (!info.current || !info.latest) continue;
              const currentMajor = parseInt(info.current.split(".")[0]);
              const latestMajor = parseInt(info.latest.split(".")[0]);
              if (latestMajor > currentMajor) {
                majors.push({
                  name: pkg,
                  current: info.current,
                  latest: info.latest,
                  type: info.type
                });
              }
            }
            if (majors.length === 0) {
              console.log("no_updates=true");
            } else {
              const fs = require("fs");
              // Issue ë³¸ë¬¸ ìƒì„±
              let body = "## ë©”ì´ì € ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•œ ì˜ì¡´ì„±\n\n";
              body += "| íŒ¨í‚¤ì§€ | í˜„ì¬ | ìµœì‹  | ìœ í˜• |\n";
              body += "|--------|------|------|------|\n";
              for (const m of majors) {
                body += `| ${m.name} | ${m.current} | **${m.latest}** | ${m.type} |\n`;
              }
              body += "\n> ì´ IssueëŠ” ë§¤ì£¼ ì›”ìš”ì¼ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.\n";
              body += "> ì—…ë°ì´íŠ¸ ë¶ˆí•„ìš” ì‹œ ë‹«ì•„ì£¼ì„¸ìš”. ë‹¤ìŒ ì£¼ì— ìƒˆ ì—…ë°ì´íŠ¸ê°€ ìˆìœ¼ë©´ ìƒˆ Issueê°€ ìƒì„±ë©ë‹ˆë‹¤.\n";
              fs.writeFileSync("/tmp/issue-body.md", body);
              console.log("no_updates=false");
              console.log(`count=${majors.length}`);
            }
          ' >> "$GITHUB_OUTPUT"

      - name: ê¸°ì¡´ Issue í™•ì¸
        if: steps.outdated.outputs.no_updates == 'false'
        id: existing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # "dependency-major-update" ë¼ë²¨ì´ ë¶™ì€ ì—´ë¦° Issueê°€ ìˆëŠ”ì§€ í™•ì¸
          ISSUE_NUMBER=$(gh issue list --label "dependency-major-update" --state open --json number --jq '.[0].number // empty')
          if [ -n "$ISSUE_NUMBER" ]; then
            echo "issue_exists=true" >> "$GITHUB_OUTPUT"
            echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
          else
            echo "issue_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Issue ì—…ë°ì´íŠ¸ (ê¸°ì¡´ Issueê°€ ìˆëŠ” ê²½ìš°)
        if: steps.outdated.outputs.no_updates == 'false' && steps.existing.outputs.issue_exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ steps.existing.outputs.issue_number }} \
            --body "$(cat /tmp/issue-body.md)"

      - name: ìƒˆ Issue ìƒì„±
        if: steps.outdated.outputs.no_updates == 'false' && steps.existing.outputs.issue_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ë¼ë²¨ì´ ì—†ìœ¼ë©´ ìƒì„±
          gh label create "dependency-major-update" \
            --description "ë©”ì´ì € ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ì•Œë¦¼" \
            --color "0075ca" 2>/dev/null || true
          gh issue create \
            --title "ğŸ“¦ ë©”ì´ì € ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ${{ steps.outdated.outputs.count }}ê±´ í™•ì¸" \
            --body "$(cat /tmp/issue-body.md)" \
            --label "dependency-major-update"

name: Dependabot Auto-Merge

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-merge:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Dependabot 메타데이터 조회
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: minor/patch 업데이트 자동 승인 및 머지
        if: steps.metadata.outputs.update-type != 'version-update:semver-major'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          gh pr review "$PR_URL" --approve --body "✅ minor/patch 업데이트 자동 승인"

          # 모든 CI 체크 완료 대기 (Lint, Test, Audit, Lighthouse 포함)
          echo "모든 CI 체크 완료 대기 중..."
          if gh pr checks "$PR_URL" --watch --fail-fast; then
            echo "✅ 모든 CI 체크 통과 — 머지 진행"
            gh pr merge "$PR_URL" --squash
          else
            echo "❌ CI 체크 실패 — 자동 머지를 건너뜁니다."
          fi

      - name: 메이저 업데이트 라벨 추가
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          gh pr edit "$PR_URL" --add-label "major-update,needs-review"
          gh pr comment "$PR_URL" --body "$(cat <<'COMMENT'
          ⚠️ **메이저 버전 업데이트입니다.**

          Breaking change가 포함될 수 있으므로 수동 검토가 필요합니다.
          CI가 통과하더라도 자동 머지되지 않습니다.

          확인 사항:
          - [ ] 마이그레이션 가이드 확인
          - [ ] 로컬에서 빌드/테스트 통과 확인
          - [ ] breaking change 영향 범위 확인
          COMMENT
          )"
